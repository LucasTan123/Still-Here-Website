<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StillHereWebsite</title>

<link href="https://fonts.googleapis.com/css2?family=Just+Me+Again+Down+Here&display=swap" rel="stylesheet">

<style>
* { font-family: "Just Me Again Down Here", cursive; font-size: 22px; }
body {
    background: #d8cbb0;
    background-image: radial-gradient(rgba(0,0,0,0.06) 1px, transparent 1px),
                      linear-gradient(#d8cbb0, #cfc2a6);
    color: #1b1b1b; padding: 40px;
}
.header { text-align: center; margin-bottom: 40px; }
.header img { width: 300px; }
.card {
    background: #f2e6c9; padding: 30px; margin-bottom: 35px;
    border: 3px solid #1b1b1b;
    box-shadow: 6px 6px 0 #1b1b1b, inset 0 0 35px rgba(0,0,0,0.25);
    position: relative;
}
.card::before {
    content: ""; position: absolute; inset: 0;
    background: radial-gradient(rgba(0,0,0,0.12) 1px, transparent 1px);
    background-size: 3px 3px; mix-blend-mode: multiply; pointer-events: none;
}
h2 { font-size: 40px; letter-spacing: 2px; margin-top: 0; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 14px; font-size: 26px; border-bottom: 2px solid #1b1b1b; }
th { text-transform: uppercase; }
.left { text-align: left; }
.right { text-align: right; }
</style>
</head>

<body>

<div class="header">
    <img src="StillHereLogo.png" alt="Still Here Logo">
</div>

<div class="card">
    <h2>Player Stats</h2>
    <p><strong>Endings Achieved:</strong> <span id="endings">0</span></p>
</div>

<div class="card">
    <h2>Previous Runs</h2>
    <table>
        <tr>
            <th class="left">Run</th>
            <th class="right">Time</th>
        </tr>
        <tbody id="runs"></tbody>
    </table>
</div>

<div class="card">
    <h2>Leaderboard</h2>
    <table>
        <tr>
            <th class="left">Name</th>
            <th class="right">Best Time</th>
        </tr>
        <tbody id="leaderboard"></tbody>
    </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBuEKw2v6nzXlbWh4TGJgdpSEg8tJ3M8zA",
    authDomain: "still-here-b0b26.firebaseapp.com",
    databaseURL: "https://still-here-b0b26-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "still-here-b0b26",
    storageBucket: "still-here-b0b26.appspot.com",
    messagingSenderId: "108127904042",
    appId: "1:108127904042:web:fd2fbd5ad00db758197e53"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Hard‑coded target UID
const targetUid = "XZMCf5Tb3aPCbwEP9C0DJCbh9EC3";

onAuthStateChanged(auth, (user) => {
    if (!user) {
        console.warn("⚠️ No authenticated user on stats page. Database rules may block reads.");
        return;
    }
    console.log("Authenticated user on stats page:", user.uid);

    // --- Player Stats + Runs for target UID ---
    onValue(ref(db, "PlayerData/" + targetUid), (snapshot) => {
        console.log("✅ onValue callback fired for target UID");

        if (!snapshot.exists()) {
            console.warn("⚠️ No data found for UID:", targetUid);
            return;
        }

        const userData = snapshot.val();
        console.log("User data for target UID:", userData);

        // Endings
        document.getElementById("endings").innerText =
            (userData.Endings && userData.Endings.length) ? userData.Endings.length : 0;

        // Previous Runs
        const runsTable = document.getElementById("runs");
        runsTable.innerHTML = "";
        const runsArray = userData.PreviousRuns || [];
        console.log("PreviousRuns array:", runsArray);

        runsArray.slice(-4).forEach((run, index) => {
            console.log("Run object:", run);
            runsTable.innerHTML += `
                <tr>
                    <td class="left">Run ${runsArray.length - 4 + index + 1}</td>
                    <td class="right">${formatTime(run.Time)}</td>
                </tr>
            `;
        });
    });

    // --- Leaderboard ---
    onValue(ref(db, "PlayerData"), (snapshot) => {
        if (!snapshot.exists()) return;
        const players = snapshot.val();

        const leaderboardEntries = Object.entries(players).map(([uid, pdata]) => {
            const runs = pdata.PreviousRuns || [];
            if (runs.length === 0) return null;
            const bestTime = Math.min(...runs.map(r => r.Time || Infinity));
            return { 
                Username: pdata.Username || pdata.Email || uid, 
                Time: bestTime 
            };
        }).filter(Boolean);

        leaderboardEntries.sort((a, b) => a.Time - b.Time);

        document.getElementById("leaderboard").innerHTML =
            leaderboardEntries.map(entry => `
                <tr>
                    <td class="left">${entry.Username}</td>
                    <td class="right">${formatTime(entry.Time)}</td>
                </tr>
            `).join("");
    });
});

function formatTime(seconds) {
    if (!seconds || seconds === Infinity) return "No runs yet";
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}m ${sec}s`;
}
</script>




</body>
</html>
