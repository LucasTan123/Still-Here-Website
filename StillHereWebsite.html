<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Still Here – Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Just+Me+Again+Down+Here&display=swap" rel="stylesheet">

<style>
* {
    font-family: "Just Me Again Down Here", cursive;
    font-size: 22px;
}

body {
    background: #d8cbb0;
    background-image:
        radial-gradient(rgba(0,0,0,0.06) 1px, transparent 1px),
        linear-gradient(#d8cbb0, #cfc2a6);
    color: #1b1b1b;
    padding: 40px;
}

/* LOGO */
.header {
    text-align: center;
    margin-bottom: 40px;
}

.header img {
    width: 300px;
}

/* PAPER CARDS */
.card {
    background: #f2e6c9;
    padding: 30px;
    margin-bottom: 35px;
    border: 3px solid #1b1b1b;
    box-shadow: 6px 6px 0 #1b1b1b, inset 0 0 35px rgba(0,0,0,0.25);
    position: relative;
}

.card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(rgba(0,0,0,0.12) 1px, transparent 1px);
    background-size: 3px 3px;
    mix-blend-mode: multiply;
    pointer-events: none;
}

h2 {
    font-size: 40px;
    letter-spacing: 2px;
    margin-top: 0;
    margin-bottom: 20px;
}

/* RUNS */
.run {
    background: #1b1b1b;
    color: #ffffff;
    padding: 18px;
    margin-bottom: 14px;
    cursor: pointer;
    font-size: 26px;
}

.run:hover {
    background: #333;
}

.run-details {
    display: none;
    margin-top: 12px;
    padding: 16px;
    background: #f2e6c9;
    font-size: 24px;
}

/* TABLE */
table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 14px;
    font-size: 26px;
    border-bottom: 2px solid #1b1b1b;
}

th {
    text-transform: uppercase;
}

.left { text-align: left; }
.right { text-align: right; }

.highlight-row {
    background: #1b1b1b;
    color: #ffffff;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="header">
    <img src="StillHereLogo.png" alt="Still Here Logo">
</div>

<div class="card">
    <h2>Player Stats</h2>
    <p><strong>Endings Achieved:</strong> <span id="endings">0</span></p>
</div>

<div class="card">
    <h2>Previous Runs</h2>
    <div id="runs"></div>
</div>

<div class="card">
    <h2>Leaderboard</h2>
    <table>
        <tr>
            <th class="left">Name</th>
            <th class="right">Time</th>
        </tr>
        <tbody id="leaderboard"></tbody>
    </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "still-here-b0b26.firebaseapp.com",
    databaseURL: "https://still-here-b0b26-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "still-here-b0b26",
    storageBucket: "still-here-b0b26.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const loggedInEmail = localStorage.getItem("loggedInEmail");

/* PLAYER + RUNS */
onValue(ref(db, "Users"), (snapshot) => {
    const users = snapshot.val();
    if (!users) return;

    const user = Object.values(users).find(u => u.Email === loggedInEmail);
    if (!user) return;

    document.getElementById("endings").innerText = user.Endings || 0;

    const runsContainer = document.getElementById("runs");
    runsContainer.innerHTML = "";

    if (!user.Runs) return;

    Object.values(user.Runs)
        .sort((a, b) => (a.RunNumber ?? 0) - (b.RunNumber ?? 0))
        .slice(0, 4)
        .forEach(run => {
            const div = document.createElement("div");
            div.className = "run";

            div.innerHTML = `
                <strong>Run ${run.RunNumber}</strong> — ${formatTime(run.Time)}
                <div class="run-details">
                    <p><strong>Run Number:</strong> ${run.RunNumber}</p>
                    <p><strong>Time:</strong> ${formatTime(run.Time)}</p>
                    <p><strong>Tasks Completed:</strong></p>
                    ${Object.entries(run.TasksCompleted || {}).map(
                        ([task, count]) => `<p>- ${task}: ${count}</p>`
                    ).join("")}
                </div>
            `;

            div.onclick = () => {
                const details = div.querySelector(".run-details");
                details.style.display =
                    details.style.display === "block" ? "none" : "block";
            };

            runsContainer.appendChild(div);
        });
});

/* LEADERBOARD */
onValue(ref(db, "Leaderboard"), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    data.sort((a, b) => a.Time - b.Time);

    document.getElementById("leaderboard").innerHTML =
        data.map(entry => `
            <tr class="${entry.Username === loggedInEmail ? 'highlight-row' : ''}">
                <td class="left">${entry.Username}</td>
                <td class="right">${formatTime(entry.Time)}</td>
            </tr>
        `).join("");
});

/* TIME FORMAT */
function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}m ${sec}s`;
}
</script>

</body>
</html>
